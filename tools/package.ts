#!/usr/bin/env -S deno run --allow-run --allow-read --allow-write --unstable

import luamin from 'https://esm.sh/luamin'
import vkbeautify from 'https://esm.sh/vkbeautify'

const dirs = ['./out']
const LicenseDir = './LICENSE'

let Proc = Deno.run({ cmd: ['rbxtsc'] })
await Proc.status()

const License = Deno.readTextFileSync(LicenseDir)

function Directory(Dir: string) {
	for (const dirEntry of Deno.readDirSync(Dir)) {
		const dirEntryFullName = Dir + '/' + dirEntry.name

		if (dirEntry.isDirectory === true) {
			Directory(dirEntryFullName)
		} else {
			if (dirEntry.name.split('.')[1] === 'lua') {
				console.log(`Minifying ${dirEntry.name}...`)
				const minified = luamin.minify(Deno.readTextFileSync(dirEntryFullName))
				Deno.writeTextFile(dirEntryFullName, `--[[\n${License}--]]\n${minified}`)
			}
		}
	}
}

dirs.forEach((dir) => Directory(dir))

Proc = Deno.run({ cmd: ['rojo', 'build', '-o', 'MainModule.rbxmx'] } as unknown as {cmd: [string]})
await Proc.status()

const MainModule = './MainModule.rbxmx'
const MainModuleUnFMT = Deno.readTextFileSync(MainModule)
const minified = vkbeautify.xmlmin(MainModuleUnFMT)
Deno.writeTextFile(MainModule, minified)