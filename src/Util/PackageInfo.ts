import { HttpService, RunService } from '@rbxts/services'
import { $warn } from 'rbxts-transform-debug'
import { HttpEnabled } from './Http'
import { ipcClient, ipcServer } from './IPC'

const PackgeURL = 'https://raw.githubusercontent.com/Calpico-Drink/AntiExploit/main/package.json'

class PackageDefaults {
	name = 'antiexploit'
	version = '1.0.0'
	author = 'Calpico-Drink <ccalpicoo@pm.me>'
	license = 'MIT'
}

let PackageData: PackageDefaults

if (RunService.IsServer()) {
	if (HttpEnabled()) {
		PackageData = HttpService.JSONDecode<PackageDefaults>(HttpService.GetAsync(PackgeURL))
	} else {
		PackageData = new PackageDefaults()
		$warn(
			'Unable to connect to internet, defaults are being used. Please run this in the Command Bar: game:GetService("HttpService").HttpEnabled = true'
		)
	}
	ipcServer.on('get-packageinfo', (Player) => {
		ipcServer.emit('return-packageinfo', Player, PackageData)
	})
} else {
	let Returned = false
	ipcClient.on('return-packageinfo', (Info) => {
		Returned = true
		PackageData = Info as PackageDefaults
	})
	ipcClient.emit('get-packageinfo')
	while (Returned === false) {
		wait()
	}
}

export { PackageData }
