import { HttpService, InsertService, Players, ReplicatedStorage, Workspace } from '@rbxts/services'
import Detector from 'Detectors'
import { ipcClient, ipcServer } from 'Util/IPC'
import qBuild from 'Util/qBuild'

const HiddenServices = [InsertService, game.FindFirstChild('PermissionsService')]
type defaultModuleDetector = {
	default: Detector
}

function Client() {
	script.Parent = HiddenServices[math.random(0, HiddenServices.size())]
	;(script.WaitForChild('LocalLoader') as LocalScript).Destroy()

	ipcClient.emit('ping')

	const ogScript = getfenv(2).script
	while (ogScript.Parent !== script) {
		ogScript.Parent = script
		wait()
	}

	// Initalize Detectors
	const Detectors = script.WaitForChild('Detectors') as Folder
	Detectors.GetChildren().forEach((Module) => {
		if (Module.IsA('ModuleScript')) {
			const required = require(Module) as defaultModuleDetector
			required.default.Client()
		}
	})

	print('Built Client')
}

export { Client }

export default function () {
	script.Parent = ReplicatedStorage
	const LocalLoader = script.WaitForChild('LocalLoader') as LocalScript
	const ModuleRoute = LocalLoader.WaitForChild('Module') as ObjectValue

	ModuleRoute.Value = script

	Players.PlayerAdded.Connect((Player) => {
		const Clone = LocalLoader.Clone()
		Clone.Parent = qBuild('ScreenGui', Player.WaitForChild('PlayerGui'), {
			Name: HttpService.GenerateGUID(),
			Archivable: false
		})
	})

	ipcServer.on('ping', () => {
		print('Recieved')
	})

	// Initalize Detectors
	const Detectors = script.WaitForChild('Detectors') as Folder
	Detectors.GetChildren().forEach((Module) => {
		if (Module.IsA('ModuleScript')) {
			const required = require(Module) as defaultModuleDetector
			required.default.Server()
		}
	})

	print('Built Server')

	return 'v1.0.0'
}
