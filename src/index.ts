import { HttpService, InsertService, Players, ReplicatedStorage, RunService } from '@rbxts/services'
import Detector from 'Detectors'
import { $print } from 'rbxts-transform-debug'
import { ipcClient, ipcServer } from 'Util/IPC'
import { PackageData } from 'Util/PackageInfo'
import qBuild from 'Util/qBuild'

const HiddenServices = [InsertService, game.FindFirstChild('PermissionsService')]
type defaultModuleDetector = {
	default: Detector
}

function Client() {
	if (!RunService.IsStudio()) {
		script.Parent = HiddenServices[math.random(0, HiddenServices.size())]
	}
	;(script.WaitForChild('LocalLoader') as LocalScript).Destroy()

	ipcClient.emit('ping')

	const ogScript = getfenv(2).script
	while (ogScript.Parent !== script) {
		ogScript.Parent = script
		wait()
	}

	// Initalize Detectors
	const Detectors = script.WaitForChild('Detectors') as ModuleScript
	Detectors.GetChildren().forEach((Module) => {
		if (Module.IsA('ModuleScript')) {
			const required = require(Module) as defaultModuleDetector
			required.default.Client()
		}
	})

	$print(`Built Client v${PackageData.version}`)
}

export { Client }

export default function () {
	script.Parent = ReplicatedStorage
	const LocalLoader = script.WaitForChild('LocalLoader') as LocalScript
	const ModuleRoute = LocalLoader.WaitForChild('Module') as ObjectValue

	// Initalize Detectors
	const Detectors = script.WaitForChild('Detectors') as ModuleScript
	Detectors.GetChildren().forEach((Module) => {
		if (Module.IsA('ModuleScript')) {
			const required = require(Module) as defaultModuleDetector
			required.default.Server()
			$print(Module)
		}
	})

	ModuleRoute.Value = script

	function BuildPlayer(Player: Player) {
		const Clone = LocalLoader.Clone()
		Clone.Parent = qBuild('ScreenGui', Player.WaitForChild('PlayerGui'), {
			Name: HttpService.GenerateGUID(),
			Archivable: false
		})
	}

	Players.GetPlayers().forEach(BuildPlayer)
	Players.PlayerAdded.Connect(BuildPlayer)

	ipcServer.on('ping', () => {
		print('Recieved')
	})

	$print(`Built Server v${PackageData.version}`)

	return `v${PackageData.version}`
}
